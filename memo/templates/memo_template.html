<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decision Memo - {{project_name}}</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #111827;
        --muted: #6b7280;
        --card: #ffffff;
        --border: #e5e7eb;
        --soft: #f3f4f6;
        --soft2: #f9fafb;
        --code: #0b1220;
        --good: #065f46;
        --warn: #92400e;
        --bad: #991b1b;
      }

      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; line-height: 1.45; background: var(--bg); color: var(--fg); }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

      .layout { display: flex; gap: 18px; padding: 18px; max-width: 1240px; margin: 0 auto; }
      .sidebar { width: 280px; flex: 0 0 auto; position: sticky; top: 18px; align-self: flex-start; }
      .main { flex: 1 1 auto; min-width: 0; }

      .card { border: 1px solid var(--border); background: var(--card); border-radius: 12px; padding: 16px; margin: 12px 0; }
      .muted { color: var(--muted); }

      h1 { font-size: 20px; margin: 0 0 8px 0; }
      h2 { font-size: 16px; margin: 0 0 10px 0; scroll-margin-top: 14px; }

      pre { background: var(--soft2); padding: 12px; border-radius: 10px; overflow-x: auto; border: 1px solid var(--border); }
      .kv { display: grid; grid-template-columns: 220px 1fr; gap: 6px 12px; }
      .k { color: #374151; }
      .v { color: var(--fg); }

      .toc { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--soft2); }
      .toc h3 { font-size: 13px; margin: 0 0 8px 0; color: #111827; }
      .toc a { display: block; padding: 6px 8px; border-radius: 8px; color: #111827; text-decoration: none; font-size: 13px; }
      .toc a:hover { background: var(--soft); }
      .toc .meta { font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.4; }

      .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--soft2); font-size: 12px; }

      .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin: 10px 0 6px 0; }
      .toolbar input[type="search"] { flex: 1 1 260px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
      .toolbar .btn { padding: 7px 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; cursor: pointer; }
      .toolbar .btn:hover { background: var(--soft); }

      table { width: 100%; border-collapse: collapse; }
      th, td { border-top: 1px solid var(--border); padding: 10px 8px; vertical-align: top; }
      th { text-align: left; font-size: 12px; color: #374151; background: var(--soft2); border-top: 1px solid var(--border); }
      td { font-size: 13px; }
      .nowrap { white-space: nowrap; }
      .small { font-size: 12px; }
      .wrap { word-break: break-word; }
      .row-muted { color: var(--muted); }

      details > summary { cursor: pointer; user-select: none; }
      details summary { font-size: 13px; color: #111827; }
      details .hint { margin: 8px 0 0 0; }

      .badge { display: inline-flex; align-items: center; border-radius: 999px; padding: 3px 8px; font-size: 12px; border: 1px solid var(--border); background: var(--soft2); }
      .badge.good { color: var(--good); border-color: rgba(6,95,70,.25); background: rgba(6,95,70,.06); }
      .badge.warn { color: var(--warn); border-color: rgba(146,64,14,.25); background: rgba(146,64,14,.06); }
      .badge.bad { color: var(--bad); border-color: rgba(153,27,27,.25); background: rgba(153,27,27,.06); }

      .section-title { display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
      .section-title .id { font-size: 12px; color: var(--muted); }

      @media (max-width: 980px) {
        .layout { flex-direction: column; }
        .sidebar { width: auto; position: static; }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="toc">
          <h3>Decision Memo (v0)</h3>
          <a href="#sec-summary">Summary</a>
          <a href="#sec-input">Input snapshot</a>
          <a href="#sec-path">Process path</a>
          <a href="#sec-missing">Missing inputs</a>
          <a href="#sec-levers">Levers</a>
          <a href="#sec-flags">Parallel flags</a>
          <a href="#sec-checklist">Energization checklist</a>
          <a href="#sec-risk">Risk buckets & evidence</a>
          <a href="#sec-provenance">Provenance</a>
          <div class="meta">
            <div><span class="row-muted">Project</span>: <code>{{project_name}}</code></div>
            <div><span class="row-muted">Rendered</span>: <code>{{rendered_at}}</code></div>
            <div style="margin-top:8px"><span class="row-muted">Evaluated</span>: <code>{{evaluated_at}}</code></div>
          </div>
        </div>
      </aside>

      <main class="main">
        <h1>{{project_name}}</h1>
        <div class="muted small">This memo is rule-driven and audit-friendly (doc_id + loc + artifact sha256).</div>

        <div class="card" id="sec-summary">
          <div class="section-title">
            <h2>Summary</h2>
            <div class="id">v0</div>
          </div>
          <div class="kv">
            <div class="k">Operator area</div>
            <div class="v"><code>{{operator_area}}</code></div>
            <div class="k">TDSP area</div>
            <div class="v"><code>{{tdsp_area}}</code></div>
            <div class="k">Load (MW total)</div>
            <div class="v"><code>{{load_mw_total}}</code></div>
            <div class="k">COD target window</div>
            <div class="v"><code>{{cod_target_window}}</code></div>
            <div class="k">Requesting energization?</div>
            <div class="v"><code>{{is_requesting_energization}}</code></div>
            <div class="k">Process path</div>
            <div class="v"><code>{{path}}</code></div>
          </div>
        </div>

        <div class="card" id="sec-input">
          <div class="section-title">
            <h2>1) Input snapshot</h2>
            <div class="id">raw JSON (folded)</div>
          </div>
          <details>
            <summary>Show raw request JSON</summary>
            <div class="hint muted small">Tip: keep raw JSON folded for faster reading; use “Missing inputs” and checklists below.</div>
            <pre>{{request_json}}</pre>
          </details>
        </div>

        <div class="card" id="sec-path">
          <div class="section-title">
            <h2>2) Process path (deterministic)</h2>
            <div class="id">first satisfied edge wins</div>
          </div>
          <div class="muted small">Each edge shows predicate traces and citations (rule_ids) carried by that edge.</div>
          <div style="overflow-x:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">edge_id</th>
                  <th class="nowrap">from → to</th>
                  <th>criteria traces</th>
                  <th>rule_ids</th>
                </tr>
              </thead>
              <tbody>
                {{edges_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-missing">
          <div class="section-title">
            <h2>3) Missing inputs</h2>
            <div class="id">from graph + rules required_fields</div>
          </div>
          <div class="toolbar">
            <button class="btn" data-copy-target="missingChips">Copy missing fields</button>
            <span class="muted small">These are the fastest “next actions” to reduce uncertainty.</span>
          </div>
          <div class="chips" id="missingChips">
            {{missing_chips}}
          </div>
        </div>

        <div class="card" id="sec-levers">
          <div class="section-title">
            <h2>4) Levers detected</h2>
            <div class="id">structural hints</div>
          </div>
          <div class="muted small">Levers are options present in the request (v0 does not simulate alternatives).</div>
          <div style="overflow-x:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">lever_id</th>
                  <th>note</th>
                </tr>
              </thead>
              <tbody>
                {{levers_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-flags">
          <div class="section-title">
            <h2>4b) Parallel flags</h2>
            <div class="id">rule predicate matches</div>
          </div>
          <div class="toolbar">
            <input id="flagsFilter" type="search" placeholder="Filter flags by rule_id, tags, doc_id, loc..." />
            <button class="btn" data-clear="flagsFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="flagsTable">
              <thead>
                <tr>
                  <th class="nowrap">rule_id</th>
                  <th class="nowrap">doc_id</th>
                  <th>loc</th>
                  <th>tags</th>
                  <th>match traces</th>
                </tr>
              </thead>
              <tbody>
                {{flags_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-checklist">
          <div class="section-title">
            <h2>4c) Energization readiness checklist</h2>
            <div class="id">tri-state gates</div>
          </div>
          <div class="muted small">Shown when <code>is_requesting_energization=true</code>. Status: <code>satisfied</code> / <code>missing</code> / <code>not_satisfied</code>.</div>
          <div class="toolbar">
            <input id="checklistFilter" type="search" placeholder="Filter checklist by status, rule_id, missing field..." />
            <button class="btn" data-clear="checklistFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="checklistTable">
              <thead>
                <tr>
                  <th class="nowrap">status</th>
                  <th class="nowrap">rule_id</th>
                  <th class="nowrap">doc_id</th>
                  <th>loc</th>
                  <th>missing fields</th>
                  <th>predicate traces</th>
                </tr>
              </thead>
              <tbody>
                {{checklist_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-risk">
          <div class="section-title">
            <h2>5) Risk buckets</h2>
            <div class="id">rule-driven v0</div>
          </div>
          <div class="kv">
            <div class="k">Status</div>
            <div class="v"><code>{{risk_status}}</code></div>
            <div class="k">P(≤12 months)</div>
            <div class="v"><code>{{bucket_le_12}}</code></div>
            <div class="k">P(12–24 months)</div>
            <div class="v"><code>{{bucket_12_24}}</code></div>
            <div class="k">P(&gt;24 months)</div>
            <div class="v"><code>{{bucket_gt_24}}</code></div>
            <div class="k">Upgrade exposure bucket</div>
            <div class="v"><code>{{upgrade_exposure}}</code></div>
            <div class="k">Operational exposure bucket</div>
            <div class="v"><code>{{operational_exposure}}</code></div>
          </div>

          <div class="section-title" style="margin-top:14px">
            <h2 style="margin:0">Evidence (rule citations)</h2>
            <div class="id">rule_id → doc_id/loc</div>
          </div>
          <div class="toolbar">
            <input id="evidenceFilter" type="search" placeholder="Filter evidence by rule_id, tags, doc_id, loc..." />
            <button class="btn" data-clear="evidenceFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="evidenceTable">
              <thead>
                <tr>
                  <th class="nowrap">rule_id</th>
                  <th class="nowrap">doc_id</th>
                  <th>loc</th>
                  <th>tags</th>
                </tr>
              </thead>
              <tbody>
                {{evidence_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-provenance">
          <div class="section-title">
            <h2>6) Provenance</h2>
            <div class="id">artifacts & sha256</div>
          </div>
          <div class="kv">
            <div class="k">Graph version</div>
            <div class="v"><code>{{graph_version}}</code></div>
            <div class="k">Graph sha256</div>
            <div class="v"><code>{{graph_sha256}}</code></div>
            <div class="k">Rules source</div>
            <div class="v"><code>{{rules_source}}</code></div>
            <div class="k">Rules sha256</div>
            <div class="v"><code>{{rules_sha256}}</code></div>
          </div>
          <div class="muted small" style="margin-top:10px">Document artifacts referenced by this evaluation.</div>
          <div style="overflow-x:auto;margin-top:8px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">doc_id</th>
                  <th>title</th>
                  <th class="nowrap">effective_date</th>
                  <th>artifact path</th>
                  <th>sha256</th>
                </tr>
              </thead>
              <tbody>
                {{docs_rows}}
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <script>
      (function () {
        function textContentOfRow(tr) {
          return (tr.innerText || tr.textContent || "").toLowerCase();
        }

        function filterTable(tableId, query) {
          var tbl = document.getElementById(tableId);
          if (!tbl) return;
          var q = (query || "").trim().toLowerCase();
          var rows = tbl.querySelectorAll("tbody tr");
          for (var i = 0; i < rows.length; i++) {
            var tr = rows[i];
            if (!q) {
              tr.style.display = "";
              continue;
            }
            var ok = textContentOfRow(tr).indexOf(q) !== -1;
            tr.style.display = ok ? "" : "none";
          }
        }

        function bindFilter(inputId, tableId) {
          var input = document.getElementById(inputId);
          if (!input) return;
          input.addEventListener("input", function () {
            filterTable(tableId, input.value);
          });
        }

        function clearInput(id) {
          var el = document.getElementById(id);
          if (!el) return;
          el.value = "";
          el.dispatchEvent(new Event("input"));
        }

        function copyTextFromElementId(id) {
          var el = document.getElementById(id);
          if (!el) return;
          var txt = (el.innerText || el.textContent || "").trim();
          if (!txt) return;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(txt);
          } else {
            var ta = document.createElement("textarea");
            ta.value = txt;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }
        }

        bindFilter("evidenceFilter", "evidenceTable");
        bindFilter("flagsFilter", "flagsTable");
        bindFilter("checklistFilter", "checklistTable");

        document.addEventListener("click", function (ev) {
          var t = ev.target;
          if (!t) return;
          var clear = t.getAttribute && t.getAttribute("data-clear");
          if (clear) {
            clearInput(clear);
            return;
          }
          var copyTarget = t.getAttribute && t.getAttribute("data-copy-target");
          if (copyTarget) {
            copyTextFromElementId(copyTarget);
            return;
          }
        });
      })();
    </script>
  </body>
</html>
