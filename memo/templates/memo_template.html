<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decision Memo - {{project_name}}</title>
    <style>
      :root {
        --bg: #ffffff;
        --fg: #111827;
        --muted: #6b7280;
        --card: #ffffff;
        --border: #e5e7eb;
        --soft: #f3f4f6;
        --soft2: #f9fafb;
        --code: #0b1220;
        --good: #065f46;
        --warn: #92400e;
        --bad: #991b1b;
        --accent: #2563eb;
      }

      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; line-height: 1.45; background: var(--bg); color: var(--fg); }
      code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      a { color: var(--accent); }

      .layout { display: flex; gap: 18px; padding: 18px; max-width: 1240px; margin: 0 auto; }
      .sidebar { width: 280px; flex: 0 0 auto; position: sticky; top: 18px; align-self: flex-start; }
      .main { flex: 1 1 auto; min-width: 0; }

      .card { border: 1px solid var(--border); background: var(--card); border-radius: 12px; padding: 16px; margin: 12px 0; }
      .muted { color: var(--muted); }

      h1 { font-size: 20px; margin: 0 0 8px 0; }
      h2 { font-size: 16px; margin: 0 0 10px 0; scroll-margin-top: 14px; }

      pre { background: var(--soft2); padding: 12px; border-radius: 10px; overflow-x: auto; border: 1px solid var(--border); }
      .kv { display: grid; grid-template-columns: 220px 1fr; gap: 6px 12px; }
      .k { color: #374151; }
      .v { color: var(--fg); min-width: 0; }

      /* Horizontal scroll helpers (for long inline values like process paths) */
      .scroll-x {
        max-width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        padding-bottom: 2px;
      }
      .scroll-x code { display: inline-block; }

      .toc { border: 1px solid var(--border); border-radius: 12px; padding: 12px; background: var(--soft2); }
      .toc { max-height: calc(100vh - 36px); overflow: auto; }
      .toc h3 { font-size: 13px; margin: 0 0 8px 0; color: #111827; }
      .toc a { display: block; padding: 6px 8px; border-radius: 8px; color: #111827; text-decoration: none; font-size: 13px; }
      .toc a:hover { background: var(--soft); }
      .toc a.active { background: rgba(37,99,235,.10); outline: 1px solid rgba(37,99,235,.22); }
      .toc .meta { font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.4; }

      .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
      .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--soft2); font-size: 12px; }
      .chip.good { color: var(--good); border-color: rgba(6,95,70,.25); background: rgba(6,95,70,.06); }
      .chip.warn { color: var(--warn); border-color: rgba(146,64,14,.25); background: rgba(146,64,14,.06); }
      .chip.bad { color: var(--bad); border-color: rgba(153,27,27,.25); background: rgba(153,27,27,.06); }

      .toolbar { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin: 10px 0 6px 0; }
      .toolbar input[type="search"] { flex: 1 1 260px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
      .toolbar .btn { padding: 7px 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; cursor: pointer; }
      .toolbar .btn:hover { background: var(--soft); }
      .toolbar .btn.active { background: rgba(37,99,235,.10); outline: 1px solid rgba(37,99,235,.22); }

      .tab-panels .tab-panel { display: none; }
      .tab-panels .tab-panel.active { display: block; }

      /* Inline code styling for scanability */
      code { color: var(--code); background: rgba(243,244,246,.75); border: 1px solid var(--border); padding: 1px 6px; border-radius: 8px; font-size: 12px; white-space: nowrap; }
      pre code { background: transparent; border: 0; padding: 0; border-radius: 0; font-size: inherit; }
      .chip code, .badge code { background: transparent; border: 0; padding: 0; border-radius: 0; }

      /* Tables: allow horizontal scroll containers to prevent "vertical text" wrapping. */
      table { width: max-content; min-width: 100%; border-collapse: collapse; table-layout: auto; }
      th, td { border-top: 1px solid var(--border); padding: 10px 8px; vertical-align: top; }
      th { text-align: left; font-size: 12px; color: #374151; background: var(--soft2); border-top: 1px solid var(--border); }
      td { font-size: 13px; }
      .nowrap { white-space: nowrap; }
      .small { font-size: 12px; }
      .wrap { overflow-wrap: break-word; word-break: normal; hyphens: auto; }
      .row-muted { color: var(--muted); }
      tbody tr:nth-child(even) { background: rgba(249,250,251,.9); }
      tbody tr:hover { background: rgba(37,99,235,.06); }

      .trace-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
      .trace-wrap code { background: #fff; }

      details > summary { cursor: pointer; user-select: none; }
      details summary { font-size: 13px; color: #111827; }
      details .hint { margin: 8px 0 0 0; }

      /* Lever "flip" cells: keep compact, expandable */
      .lever-flips .chips { margin-top: 0; }
      .chip.info { color: #1d4ed8; border-color: rgba(29,78,216,.22); background: rgba(29,78,216,.06); }
      details.mini > summary { font-size: 12px; color: var(--accent); margin-top: 6px; }
      .flip-box {
        margin-top: 8px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: var(--soft2);
        max-height: 180px;
        overflow: auto;
      }
      .flip-box ul { margin: 6px 0 0 18px; padding: 0; }
      .flip-box li { margin: 4px 0; }

      /* Summary: action cards (Top next actions) */
      .action-cards { display: grid; gap: 12px; }
      .action-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
        padding: 12px;
      }
      .action-head {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        justify-content: space-between;
      }
      .action-title {
        font-size: 13px;
        font-weight: 650;
        line-height: 1.35;
        min-width: 0;
      }
      .action-title code { font-weight: 500; }
      .action-grid {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 8px 12px;
        margin-top: 10px;
      }
      .action-k { font-size: 12px; color: var(--muted); }
      .action-v { font-size: 13px; min-width: 0; }
      .action-details { margin-top: 10px; }
      .action-details > summary { font-size: 12px; color: var(--accent); }
      .done-list li { margin: 3px 0; }
      @media (max-width: 640px) {
        .action-grid { grid-template-columns: 1fr; }
      }

      .badge { display: inline-flex; align-items: center; border-radius: 999px; padding: 3px 8px; font-size: 12px; border: 1px solid var(--border); background: var(--soft2); }
      .badge.good { color: var(--good); border-color: rgba(6,95,70,.25); background: rgba(6,95,70,.06); }
      .badge.warn { color: var(--warn); border-color: rgba(146,64,14,.25); background: rgba(146,64,14,.06); }
      .badge.bad { color: var(--bad); border-color: rgba(153,27,27,.25); background: rgba(153,27,27,.06); }

      .section-title { display: flex; justify-content: space-between; gap: 10px; align-items: baseline; }
      .section-title .id { font-size: 12px; color: var(--muted); }

      .graph-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--soft2); padding: 8px; }
      svg.graph { display: block; }
      svg.graph.fit { width: 100%; height: auto; }

      /* Simple “graph view” for the selected path */
      .path-graph { display: flex; align-items: center; gap: 10px; overflow-x: auto; padding: 10px; border: 1px dashed var(--border); border-radius: 12px; background: var(--soft2); }
      .pnode { min-width: 170px; border: 1px solid var(--border); background: #fff; border-radius: 12px; padding: 10px; }
      .pnode .t { font-size: 13px; font-weight: 600; margin-bottom: 4px; }
      .pnode .s { font-size: 12px; color: var(--muted); }
      .pedge { display: grid; grid-template-rows: auto auto; align-items: center; justify-items: center; min-width: 120px; }
      .pedge .eid { font-size: 11px; color: var(--muted); white-space: nowrap; }
      .pedge .eid code { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #fff; border: 1px solid var(--border); }
      .pedge .arr { font-size: 18px; color: var(--muted); line-height: 1; }

      .back-to-top {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 20;
        display: none;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 999px;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(17,24,39,.10);
      }
      .back-to-top:hover { background: var(--soft); }

      @media (max-width: 980px) {
        .layout { flex-direction: column; }
        .sidebar { width: auto; position: static; }
      }

      @media print {
        .sidebar, .toolbar, .back-to-top { display: none !important; }
        .layout { display: block; padding: 0; max-width: none; }
        .card { break-inside: avoid; }
        body { background: #fff; }
      }

      /* ── Audience toggle ─────────────────────────────────────────────── */
      /* In exec mode, hide everything marked analyst-only */
      [data-mode="exec"] .analyst-only { display: none !important; }

      /* Mode toggle button in sidebar */
      .mode-toggle-bar {
        margin-top: 12px;
        display: flex;
        gap: 6px;
      }
      .mode-btn {
        flex: 1;
        padding: 7px 6px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        cursor: pointer;
        font-size: 12px;
        text-align: center;
        color: #374151;
      }
      .mode-btn:hover { background: var(--soft); }
      .mode-btn.active {
        background: rgba(37,99,235,.10);
        outline: 1px solid rgba(37,99,235,.30);
        color: #1d4ed8;
        font-weight: 600;
      }
    </style>

    <script>
      /* Set audience mode from URL param; default = analyst */
      (function () {
        var p = (new URLSearchParams(window.location.search)).get("mode") || "analyst";
        if (p !== "exec" && p !== "analyst") p = "analyst";
        document.documentElement.dataset.mode = p;
      })();
    </script>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="toc">
          <h3>Decision Memo (v0)</h3>
          <a href="#sec-decision">Decision memo</a>
          <a href="#sec-input">Project details</a>
          <a href="#sec-checklist">Energization checklist</a>
          <a href="#sec-options">Options comparison (full)</a>
          <a href="#sec-context" class="analyst-only">Context snapshot</a>
          <a href="#sec-path" class="analyst-only">Process path</a>
          <a href="#sec-missing" class="analyst-only">Missing inputs</a>
          <a href="#sec-uncertainty" class="analyst-only">Uncertainty &amp; deps</a>
          <a href="#sec-levers" class="analyst-only">Levers detected</a>
          <a href="#sec-flags" class="analyst-only">Parallel flags</a>
          <a href="#sec-risk" class="analyst-only">Risk detail</a>
          <a href="#sec-provenance" class="analyst-only">Provenance</a>
          <div class="meta">
            <div><span class="row-muted">Project</span>: <code>{{project_name}}</code></div>
            <div><span class="row-muted">Rendered</span>: <code>{{rendered_at}}</code></div>
            <div style="margin-top:8px"><span class="row-muted">Evaluated</span>: <code>{{evaluated_at}}</code></div>
          </div>
          <div class="mode-toggle-bar">
            <button class="mode-btn" id="modeBtnExec" onclick="setMode('exec')" title="Executive view: hides raw evidence, IDs, and audit tables">Exec view</button>
            <button class="mode-btn" id="modeBtnAnalyst" onclick="setMode('analyst')" title="Analyst view: shows all sections and evidence">Analyst view</button>
          </div>
          <div class="meta" style="margin-top:6px">
            <span class="muted" style="font-size:11px">Exec = hides audit tables &amp; IDs. Analyst = full detail.</span>
          </div>
        </div>
      </aside>

      <main class="main">
        <h1>{{project_name}}</h1>
        <div class="muted small">Large Load Screening — Decision Brief &nbsp;·&nbsp; <em>Forwardable to PM / legal / procurement / leadership</em></div>

        <!-- ══ DECISION MEMO (exec view) ══════════════════════════════════════ -->
        <div class="card" id="sec-decision">
          <div class="section-title">
            <h2>Decision Memo</h2>
            <div class="id">non-technical · forwardable</div>
          </div>

          <!-- Status + recommendation + actions + drivers + options-compact all come from executive_brief_html -->
          <div style="margin-top:10px">
            {{executive_brief_html}}
          </div>

          <!-- PDF download (collapsed) -->
          <details style="margin-top:14px">
            <summary class="muted small">Show / download PDF version</summary>
            <div style="margin-top:8px">
              <a class="btn" href="pdfs/{{pdf_filename}}" target="_blank" rel="noopener">Open PDF</a>
              <a class="btn" href="pdfs/{{pdf_filename}}" download>Download PDF</a>
            </div>
          </details>

          <!-- Disclaimer (one line) -->
          <div style="border-top:1px solid var(--border);margin-top:14px;padding-top:8px;font-size:11px;color:var(--muted)">
            Screening brief only — not legal advice. Final outcomes depend on ERCOT / TSP / TDSP studies and approvals.
            <span class="analyst-only">Full evidence + audit log in sections below.</span>
          </div>
        </div>

        <!-- ══ PROJECT DETAILS ════════════════════════════════════════════════ -->
        <div class="card" id="sec-input">
          <div class="section-title">
            <h2>Project details</h2>
            <div class="id">input snapshot</div>
          </div>
          <div class="kv" style="margin-top:8px">
            <div class="k">Operator area</div>
            <div class="v"><code>{{operator_area}}</code></div>
            <div class="k">TDSP area</div>
            <div class="v"><code>{{tdsp_area}}</code></div>
            <div class="k">Load (MW total)</div>
            <div class="v"><code>{{load_mw_total}}</code></div>
            <div class="k">COD target window</div>
            <div class="v"><code>{{cod_target_window}}</code></div>
            <div class="k">Requesting energization?</div>
            <div class="v"><code>{{is_requesting_energization}}</code></div>
            <div class="k">Process path</div>
            <div class="v"><div class="scroll-x"><code>{{path}}</code></div></div>
          </div>
          <details style="margin-top:10px" class="analyst-only">
            <summary>Show raw request JSON</summary>
            <pre>{{request_json}}</pre>
          </details>
        </div>

        <div class="card analyst-only" id="sec-context">
          <div class="section-title">
            <h2>Context snapshot</h2>
            <div class="id">audit-friendly</div>
          </div>
          <div class="muted small">Optional system-state / discretion inputs provided by the user. These are recorded with source + confidence and can influence v0 risk/recommendation deterministically. They are not citation-audited like published rules.</div>
          <div style="margin-top:10px">
            {{context_snapshot_html}}
          </div>
        </div>

        <div class="card analyst-only" id="sec-path">
          <div class="section-title">
            <h2>Process path (deterministic)</h2>
            <div class="id">first satisfied edge wins</div>
          </div>
          <div class="muted small">Full process graph (from <code>graph/process_graph.yaml</code>) with the selected path highlighted.</div>

          <details style="margin-top:10px" class="analyst-only">
            <summary>Show full process graph</summary>
            <div class="toolbar" style="margin-top:10px">
              <span class="muted small">Zoom</span>
              <button class="btn" data-graph-zoom="fit">Fit</button>
              <button class="btn" data-graph-zoom="1">100%</button>
              <button class="btn" data-graph-zoom="1.25">125%</button>
              <button class="btn" data-graph-zoom="1.5">150%</button>
              <button class="btn" data-graph-zoom="2">200%</button>
              <button class="btn" data-graph-zoom="reset">Reset</button>
              <span class="muted small">Tip: use scroll to pan</span>
            </div>
            <div class="graph-wrap" id="fullGraphWrap">
              {{full_graph_svg}}
            </div>
          </details>

          <details style="margin-top:10px">
            <summary>Show selected path (compact)</summary>
            {{path_graph}}
          </details>

          <details style="margin-top:10px" class="analyst-only">
            <summary>Show edge audit log (predicate traces + citations)</summary>
            <div style="overflow-x:auto;margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th class="nowrap">edge_id</th>
                    <th class="nowrap">from → to</th>
                    <th>criteria traces</th>
                    <th>rule_ids</th>
                  </tr>
                </thead>
                <tbody>
                  {{edges_rows}}
                </tbody>
              </table>
            </div>
          </details>
        </div>

        <div class="card analyst-only" id="sec-missing">
          <div class="section-title">
            <h2>Missing inputs (detail)</h2>
            <div class="id">from graph + rules required_fields</div>
          </div>
          <div class="toolbar">
            <button class="btn" data-copy-target="missingChips">Copy missing fields</button>
          </div>
          <div class="chips" id="missingChips">
            {{missing_chips}}
          </div>
        </div>

        <div class="card analyst-only" id="sec-uncertainty">
          <div class="section-title">
            <h2>Uncertainty &amp; dependencies</h2>
            <div class="id">analyst</div>
          </div>
          <div class="muted small">
            This section separates <code>missing</code> vs explicit <code>unknown</code> inputs, and highlights non-cited assumptions and external dependencies.
          </div>
          <div style="margin-top:10px">
            {{uncertainty_html}}
          </div>
        </div>

        <div class="card analyst-only" id="sec-levers">
          <div class="section-title">
            <h2>Levers detected</h2>
            <div class="id">structural hints</div>
          </div>
          <div class="muted small">
            Levers are decision inputs surfaced from the request + rules. Class legend: <code>design</code> (you can change it), <code>hard</code> (site/physical constraint), <code>external</code> (system/queue state).
            See “Options comparison” for lightweight what-if variants when available.
          </div>

          <details style="margin-top:10px" open>
            <summary>Top levers to decide next (v0)</summary>
            <div class="hint muted small">
              This is a compact, evidence-backed guide: which lever matters, what to ask next, and which rule checks will be unblocked.
            </div>
            {{lever_next_actions_html}}
          </details>

          <div style="overflow-x:auto;margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">lever_id</th>
                  <th class="nowrap">class</th>
                  <th>note</th>
                </tr>
              </thead>
              <tbody>
                {{levers_rows}}
              </tbody>
            </table>
          </div>

          <details style="margin-top:10px">
            <summary>Show lever coverage (rules referencing lever fields)</summary>
            <div class="hint muted small">
              This helps prioritize rule clusters: levers with low coverage are good candidates for targeted, high-signal rules.
            </div>
            {{levers_catalog_html}}
          </details>
        </div>

        <div class="card" id="sec-options">
          <div class="section-title">
            <h2>4a) Options comparison</h2>
            <div class="id">lever variants</div>
          </div>
          <div class="muted small">
            v0 can generate lightweight “what-if” variants for certain levers (e.g., voltage choice, phased vs single). These are comparative screenings, not final determinations. The <code>source</code> column distinguishes user-provided alternatives vs system-generated toggles.
          </div>
          <div class="toolbar">
            <input id="optionsFilter" type="search" placeholder="Filter options by lever, option, risk bucket, missing field..." />
            <button class="btn" data-clear="optionsFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="optionsTable">
              <thead>
                <tr>
                  <th class="nowrap">option_id</th>
                  <th class="nowrap">lever</th>
                  <th class="nowrap">source</th>
                  <th>patch</th>
                  <th>path</th>
                  <th class="nowrap">missing</th>
                  <th class="nowrap">delta</th>
                  <th class="nowrap">risk</th>
                  <th>edge diff + why</th>
                </tr>
              </thead>
              <tbody>
                {{options_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card analyst-only" id="sec-flags">
          <div class="section-title">
            <h2>4b) Parallel flags</h2>
            <div class="id">rule predicate matches</div>
          </div>
          <div class="toolbar">
            <input id="flagsFilter" type="search" placeholder="Filter flags by rule_id, tags, doc_id, loc..." />
            <button class="btn" data-clear="flagsFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="flagsTable">
              <thead>
                <tr>
                  <th class="nowrap">rule_id</th>
                  <th class="nowrap">doc_id</th>
                  <th>loc</th>
                  <th>tags</th>
                  <th>match traces</th>
                </tr>
              </thead>
              <tbody>
                {{flags_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" id="sec-checklist">
          <div class="section-title">
            <h2>4c) Energization readiness checklist</h2>
            <div class="id">tri-state gates</div>
          </div>
          <div class="muted small">Shown when <code>is_requesting_energization=true</code>. Status: <code>satisfied</code> / <code>missing</code> / <code>not_satisfied</code> / <code>unknown</code> (needs applicability confirmation).</div>
          <div class="chips" style="margin-top:10px">
            {{checklist_stats_chips}}
          </div>
          <div class="toolbar">
            <input id="checklistFilter" type="search" placeholder="Filter checklist by status, rule_id, missing field..." />
            <button class="btn" data-clear="checklistFilter">Clear</button>
          </div>
          <div style="overflow-x:auto;margin-top:8px">
            <table id="checklistTable">
              <thead>
                <tr>
                  <th class="nowrap">status</th>
                  <th>requirement (human-readable)</th>
                  <th>missing fields</th>
                  <th>predicate traces</th>
                  <th>guidance</th>
                </tr>
              </thead>
              <tbody>
                {{checklist_rows}}
              </tbody>
            </table>
          </div>
        </div>

        <div class="card analyst-only" id="sec-risk">
          <div class="section-title">
            <h2>Risk buckets (detail)</h2>
            <div class="id">rule-driven v0</div>
          </div>
          <div class="muted small" style="margin-bottom:10px">
            <strong>Important</strong>: timeline signals are <strong>directional, qualitative shifts</strong> derived from deterministic rule/tag scoring (v0). They are <strong>not probabilities</strong>.
            Legend: <code>up</code> = pressure toward that window; <code>down</code> = pressure away; <code>unknown</code> = insufficient rule coverage.
          </div>
          <div class="kv">
            <div class="k">Status</div>
            <div class="v"><code>{{risk_status}}</code></div>
            <div class="k">Timeline signal (≤12 months)</div>
            <div class="v"><code>{{bucket_le_12}}</code></div>
            <div class="k">Timeline signal (12–24 months)</div>
            <div class="v"><code>{{bucket_12_24}}</code></div>
            <div class="k">Timeline signal (&gt;24 months)</div>
            <div class="v"><code>{{bucket_gt_24}}</code></div>
            <div class="k">Upgrade exposure bucket</div>
            <div class="v"><code>{{upgrade_exposure}}</code></div>
            <div class="k">Operational exposure bucket</div>
            <div class="v"><code>{{operational_exposure}}</code></div>
          </div>

          <details style="margin-top:10px" class="analyst-only">
            <summary>Show how timeline signals are computed (v0 mapping)</summary>
            {{timeline_model_html}}
          </details>

          <div class="section-title analyst-only" style="margin-top:14px">
            <h2 style="margin:0">Evidence (rules + heuristics)</h2>
            <div class="id">rule_id → doc_id/loc (heuristics are explicitly marked)</div>
          </div>
          <div class="chips analyst-only" style="margin-top:10px">
            {{evidence_stats_chips}}
          </div>

          <details style="margin-top:10px" class="analyst-only">
            <summary>Show evidence (grouped + filterable)</summary>
            <div class="hint muted small">
              Tip: use “Group by doc/tag” for scanning; use “Flat table” + filter for precise lookup.
            </div>
            <div class="toolbar">
              <button class="btn active" data-tab-group="evidence" data-tab-target="evidenceFlat">Flat table</button>
              <button class="btn" data-tab-group="evidence" data-tab-target="evidenceByDoc">Group by doc</button>
              <button class="btn" data-tab-group="evidence" data-tab-target="evidenceByTag">Group by tag</button>
              <span class="muted small">Total: <code>{{evidence_total_count}}</code></span>
            </div>

            <div class="tab-panels" data-tab-panels="evidence">
              <div class="tab-panel active" id="evidenceFlat">
                <div class="toolbar">
                  <input id="evidenceFilter" type="search" placeholder="Filter evidence by rule_id, tags, doc_id, loc..." />
                  <button class="btn" data-clear="evidenceFilter">Clear</button>
                </div>
                <div style="overflow-x:auto;margin-top:8px">
                  <table id="evidenceTable">
                    <thead>
                      <tr>
                        <th class="nowrap">rule_id</th>
                        <th class="nowrap">doc_id</th>
                        <th>loc</th>
                        <th>tags</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{evidence_rows}}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="tab-panel" id="evidenceByDoc">
                {{evidence_grouped_by_doc}}
              </div>

              <div class="tab-panel" id="evidenceByTag">
                {{evidence_grouped_by_tag}}
              </div>
            </div>
          </details>

          <details style="margin-top:10px" class="analyst-only">
            <summary>Show risk trace (reproducible scoring)</summary>
            <div class="hint muted small">This is a machine-readable trace of per-rule/heuristic score contributions and final bucket assignment.</div>
            <pre>{{risk_trace_json}}</pre>
          </details>
        </div>

        <div class="card analyst-only" id="sec-provenance">
          <div class="section-title">
            <h2>6) Provenance</h2>
            <div class="id">artifacts & sha256</div>
          </div>
          <div class="kv">
            <div class="k">Graph version</div>
            <div class="v"><code>{{graph_version}}</code></div>
            <div class="k">Graph sha256</div>
            <div class="v"><code>{{graph_sha256}}</code></div>
            <div class="k">Rules source</div>
            <div class="v"><code>{{rules_source}}</code></div>
            <div class="k">Rules sha256</div>
            <div class="v"><code>{{rules_sha256}}</code></div>
            <div class="k">Citation audit (PDF)</div>
            <div class="v"><code>{{citation_audit_mode}}</code> / <code>{{citation_audit_ok}}</code> (errors: <code>{{citation_audit_error_count}}</code>, warns: <code>{{citation_audit_warn_count}}</code>)</div>
          </div>
          <details style="margin-top:10px">
            <summary>Show citation audit findings</summary>
            <div class="hint muted small">This audit checks PDF sha256, loc page range, and loc anchor matches for published rules.</div>
            <div style="overflow-x:auto;margin-top:8px">
              <table>
                <thead>
                  <tr>
                    <th class="nowrap">status</th>
                    <th class="nowrap">rule_id</th>
                    <th class="nowrap">doc_id</th>
                    <th>loc</th>
                    <th class="nowrap">anchor</th>
                    <th>message</th>
                  </tr>
                </thead>
                <tbody>
                  {{citation_audit_rows}}
                </tbody>
              </table>
            </div>
          </details>
          <div class="muted small" style="margin-top:10px">Document artifacts referenced by this evaluation.</div>
          <div style="overflow-x:auto;margin-top:8px">
            <table>
              <thead>
                <tr>
                  <th class="nowrap">doc_id</th>
                  <th>title</th>
                  <th class="nowrap">effective_date</th>
                  <th>artifact path</th>
                  <th>sha256</th>
                </tr>
              </thead>
              <tbody>
                {{docs_rows}}
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <button class="back-to-top" id="backToTop" type="button" title="Back to top">↑ Top</button>

    <script>
      /* ── Audience mode toggle ─────────────────────────────────────────── */
      function setMode(m) {
        if (m !== "exec" && m !== "analyst") m = "analyst";
        document.documentElement.dataset.mode = m;
        var execBtn = document.getElementById("modeBtnExec");
        var analystBtn = document.getElementById("modeBtnAnalyst");
        if (execBtn) execBtn.classList.toggle("active", m === "exec");
        if (analystBtn) analystBtn.classList.toggle("active", m === "analyst");
        /* Update URL so refreshing preserves mode without reload */
        try {
          var url = new URL(window.location.href);
          url.searchParams.set("mode", m);
          history.replaceState(null, "", url.toString());
        } catch(e) {}
      }

      (function () {
        /* Sync button active states on load */
        var mode = document.documentElement.dataset.mode || "analyst";
        var execBtn = document.getElementById("modeBtnExec");
        var analystBtn = document.getElementById("modeBtnAnalyst");
        if (execBtn) execBtn.classList.toggle("active", mode === "exec");
        if (analystBtn) analystBtn.classList.toggle("active", mode === "analyst");
      })();

      (function () {
        function bindScrollSpy() {
          var links = document.querySelectorAll(".toc a[href^='#']");
          if (!links || !links.length) return;
          var sections = [];
          for (var i = 0; i < links.length; i++) {
            var id = (links[i].getAttribute("href") || "").slice(1);
            var el = document.getElementById(id);
            if (el) sections.push({ id: id, el: el, link: links[i] });
          }
          if (!sections.length || !window.IntersectionObserver) return;
          var obs = new IntersectionObserver(function (entries) {
            var best = null;
            for (var j = 0; j < entries.length; j++) {
              var ent = entries[j];
              if (!ent.isIntersecting) continue;
              if (!best) best = ent;
              else if (ent.intersectionRatio > best.intersectionRatio) best = ent;
            }
            if (!best) return;
            var activeId = best.target && best.target.id;
            for (var k = 0; k < sections.length; k++) {
              var s = sections[k];
              if (!s.link || !s.el) continue;
              if (s.id === activeId) s.link.classList.add("active");
              else s.link.classList.remove("active");
            }
          }, { root: null, rootMargin: "-20% 0px -70% 0px", threshold: [0.05, 0.1, 0.2, 0.4, 0.6] });
          for (var t = 0; t < sections.length; t++) obs.observe(sections[t].el);
        }

        function textContentOfRow(tr) {
          return (tr.innerText || tr.textContent || "").toLowerCase();
        }

        function filterTable(tableId, query) {
          var tbl = document.getElementById(tableId);
          if (!tbl) return;
          var q = (query || "").trim().toLowerCase();
          var rows = tbl.querySelectorAll("tbody tr");
          for (var i = 0; i < rows.length; i++) {
            var tr = rows[i];
            if (!q) {
              tr.style.display = "";
              continue;
            }
            var ok = textContentOfRow(tr).indexOf(q) !== -1;
            tr.style.display = ok ? "" : "none";
          }
        }

        function bindFilter(inputId, tableId) {
          var input = document.getElementById(inputId);
          if (!input) return;
          input.addEventListener("input", function () {
            filterTable(tableId, input.value);
          });
        }

        function clearInput(id) {
          var el = document.getElementById(id);
          if (!el) return;
          el.value = "";
          el.dispatchEvent(new Event("input"));
        }

        function copyTextFromElementId(id) {
          var el = document.getElementById(id);
          if (!el) return;
          var txt = (el.innerText || el.textContent || "").trim();
          if (!txt) return;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(txt);
          } else {
            var ta = document.createElement("textarea");
            ta.value = txt;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }
        }

        bindFilter("evidenceFilter", "evidenceTable");
        bindFilter("flagsFilter", "flagsTable");
        bindFilter("checklistFilter", "checklistTable");
        bindFilter("optionsFilter", "optionsTable");

        document.addEventListener("click", function (ev) {
          var t = ev.target;
          if (!t) return;
          var zoom = t.getAttribute && t.getAttribute("data-graph-zoom");
          if (zoom) {
            var wrap = document.getElementById("fullGraphWrap");
            var svg = wrap && wrap.querySelector && wrap.querySelector("svg.graph");
            if (!wrap || !svg) return;
            var baseW = parseFloat(svg.getAttribute("width") || "0");
            var baseH = parseFloat(svg.getAttribute("height") || "0");
            if (!baseW || !baseH) return;
            var defaultZoom = 1.25;

            function applyZoom(z) {
              svg.classList.remove("fit");
              svg.style.width = String(baseW * z) + "px";
              svg.style.height = String(baseH * z) + "px";
            }

            function applyFit() {
              svg.classList.add("fit");
              svg.style.width = "";
              svg.style.height = "";
            }

            if (zoom === "fit") {
              applyFit();
            } else if (zoom === "reset") {
              applyZoom(defaultZoom);
            } else {
              var z = parseFloat(zoom);
              if (!isNaN(z)) applyZoom(z);
            }
            return;
          }
          var clear = t.getAttribute && t.getAttribute("data-clear");
          if (clear) {
            clearInput(clear);
            return;
          }
          var copyTarget = t.getAttribute && t.getAttribute("data-copy-target");
          if (copyTarget) {
            copyTextFromElementId(copyTarget);
            return;
          }
          if (t && t.id === "backToTop") {
            window.scrollTo({ top: 0, behavior: "smooth" });
            return;
          }

          var tabGroup = t.getAttribute && t.getAttribute("data-tab-group");
          var tabTarget = t.getAttribute && t.getAttribute("data-tab-target");
          if (tabGroup && tabTarget) {
            var btns = document.querySelectorAll('[data-tab-group="' + tabGroup + '"][data-tab-target]');
            for (var bi = 0; bi < btns.length; bi++) {
              btns[bi].classList.remove("active");
            }
            t.classList.add("active");
            var panelsWrap = document.querySelector('[data-tab-panels="' + tabGroup + '"]');
            if (!panelsWrap) return;
            var panels = panelsWrap.querySelectorAll(".tab-panel");
            for (var pi = 0; pi < panels.length; pi++) {
              panels[pi].classList.remove("active");
            }
            var target = document.getElementById(tabTarget);
            if (target) target.classList.add("active");
            return;
          }
        });

        (function bindBackToTop() {
          var btn = document.getElementById("backToTop");
          if (!btn) return;
          function onScroll() {
            btn.style.display = (window.scrollY || 0) > 600 ? "inline-flex" : "none";
          }
          window.addEventListener("scroll", onScroll, { passive: true });
          onScroll();
        })();

        // Default: enlarge the full graph for readability (can be overridden by buttons).
        (function initDefaultGraphZoom() {
          var wrap = document.getElementById("fullGraphWrap");
          var svg = wrap && wrap.querySelector && wrap.querySelector("svg.graph");
          if (!wrap || !svg) return;
          var baseW = parseFloat(svg.getAttribute("width") || "0");
          var baseH = parseFloat(svg.getAttribute("height") || "0");
          if (!baseW || !baseH) return;
          var z = 1.25;
          svg.classList.remove("fit");
          svg.style.width = String(baseW * z) + "px";
          svg.style.height = String(baseH * z) + "px";
        })();

        bindScrollSpy();
      })();

      /* ── Audience mode toggle ──────────────────────────────────────────── */
      function setMode(m) {
        if (m !== "exec" && m !== "analyst") m = "analyst";
        document.documentElement.dataset.mode = m;
        /* Update button active states */
        var btnExec    = document.getElementById("modeBtnExec");
        var btnAnalyst = document.getElementById("modeBtnAnalyst");
        if (btnExec)    btnExec.classList.toggle("active",    m === "exec");
        if (btnAnalyst) btnAnalyst.classList.toggle("active", m === "analyst");
        /* Persist in URL without reload */
        try {
          var sp = new URLSearchParams(window.location.search);
          sp.set("mode", m);
          window.history.replaceState(null, "", "?" + sp.toString() + window.location.hash);
        } catch (e) {}
      }

      /* Initialise button state to match whatever mode was set on load */
      (function syncModeButtons() {
        var m = document.documentElement.dataset.mode || "analyst";
        var btnExec    = document.getElementById("modeBtnExec");
        var btnAnalyst = document.getElementById("modeBtnAnalyst");
        if (btnExec)    btnExec.classList.toggle("active",    m === "exec");
        if (btnAnalyst) btnAnalyst.classList.toggle("active", m === "analyst");
      })();
    </script>
  </body>
</html>
