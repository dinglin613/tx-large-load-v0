# NOTE: edge order matters.
# The evaluator (`src/evaluate.py`) is deterministic: at each node it checks outgoing edges
# in this YAML file order, and the **first satisfied edge wins**.
version: "0.1"
operator_stack:
  - ERCOT
  - TDSP
  - POI

nodes:
  - id: N0
    label: Intake
  - id: N1
    label: Large Load Intake (ERCOT)
  - id: N2
    label: Completeness Check
  - id: N2X
    label: "Intake Incomplete (v0: stop and request missing inputs)"
  - id: N3P
    label: Study Path (ERCOT) — Phased plan
  - id: N3S
    label: Study Path (ERCOT) — Single plan
  - id: N3R
    label: Material Change / Re-study Screening
  - id: N3T
    label: TDSP Routing
  - id: N4
    label: Facility Review (TDSP)
  - id: N4G
    label: Facility Review (TDSP - Generic/Other)
  - id: N5
    label: Risk Flags
  - id: N5E
    label: Energization Readiness (gate evaluation)
  - id: N6
    label: Decision Memo

edges:
  - id: E0
    from: N0
    to: N1
    criteria:
      - op: equals
        field: project_type
        value: large_load
    rule_ids: []

  - id: E1
    from: N1
    to: N2
    criteria: []
    rule_ids:
      - ERCOT_LLI_INTAKE_REQUIRED_DOCS
      - PG9_001_LLIS_APPLICABILITY_SUBJECT_TO_LLIS
      - LL_QA_003_TSP_INITIATION
      - LL_QA_004_LOAD_COMMISSIONING_PLAN
      - LL_QA_005_APPLICATION_FEE
      - PG9_005_LLIS_PREINIT_PRELIM_LCP_REQUIRED
      - PG9_006_LLIS_PREINIT_WRITTEN_ACK_REQUIRED
      - PG9_007_LLIS_PREINIT_FORMAL_REQUEST_REQUIRED
      - PG9_008_LLIS_PREINIT_APPLICATION_FEE_REQUIRED

  # Branch 1: plan shape (phased vs single) + minimal required fields.
  - id: E2P
    from: N2
    to: N3P
    criteria:
      - op: exists
        field: load_mw_total
      - op: exists
        field: tdsp_area
      - op: equals
        field: energization_plan
        value: phased
    rule_ids:
      - LL_QA_001_LARGE_LOAD_DEFINITION
      - ONC_003_LOAD_PROJECTION
      - ONC_004_ONE_LINE_DIAGRAM

  - id: E2S
    from: N2
    to: N3S
    criteria:
      - op: exists
        field: load_mw_total
      - op: exists
        field: tdsp_area
      - op: equals
        field: energization_plan
        value: single
    rule_ids:
      - LL_QA_001_LARGE_LOAD_DEFINITION
      - ONC_003_LOAD_PROJECTION
      - ONC_004_ONE_LINE_DIAGRAM

  # Branch 2: default route when minimal intake fields missing/unspecified.
  - id: E2X
    from: N2
    to: N2X
    criteria: []
    rule_ids:
      - ERCOT_LLI_INTAKE_REQUIRED_DOCS
      - LL_QA_004_LOAD_COMMISSIONING_PLAN
      - LL_QA_005_APPLICATION_FEE
      - PG9_005_LLIS_PREINIT_PRELIM_LCP_REQUIRED
      - PG9_006_LLIS_PREINIT_WRITTEN_ACK_REQUIRED
      - PG9_007_LLIS_PREINIT_FORMAL_REQUEST_REQUIRED
      - PG9_008_LLIS_PREINIT_APPLICATION_FEE_REQUIRED

  - id: E2X_END
    from: N2X
    to: N6
    criteria: []
    rule_ids:
      - ERCOT_LLI_INTAKE_REQUIRED_DOCS
      - ONC_003_LOAD_PROJECTION
      - ONC_004_ONE_LINE_DIAGRAM

  # Branch 3: material change / re-study signal (applies to both plans).
  - id: E3P_RESTUDY
    from: N3P
    to: N3R
    criteria:
      - op: any_true
        field: material_change_flags
        value: ["poi_changed", "timeline_accelerated", "load_type_changed", "control_system_changed"]
    rule_ids:
      - LL_QA_006_MATERIAL_CHANGE
      - PG9_011_PROJECT_INFO_UPDATE_10_BUSINESS_DAYS
      - PG9_012_DYNAMIC_MODEL_CHANGE_IMPACTS_LLIS

  - id: E3P_BASE
    from: N3P
    to: N3T
    criteria: []
    rule_ids:
      - LL_QA_007_REQUIRED_STUDIES
      - LL_QA_008_SSO_REQUIRED
      - PG9_016_STEADY_STATE_ANALYSIS_ELEMENT
      - PG9_017_SYSTEM_PROTECTION_SHORT_CIRCUIT_ELEMENT
      - PG9_018_DYNAMIC_TRANSIENT_STABILITY_ELEMENT

  - id: E3S_RESTUDY
    from: N3S
    to: N3R
    criteria:
      - op: any_true
        field: material_change_flags
        value: ["poi_changed", "timeline_accelerated", "load_type_changed", "control_system_changed"]
    rule_ids:
      - LL_QA_006_MATERIAL_CHANGE
      - PG9_011_PROJECT_INFO_UPDATE_10_BUSINESS_DAYS
      - PG9_012_DYNAMIC_MODEL_CHANGE_IMPACTS_LLIS

  - id: E3S_BASE
    from: N3S
    to: N3T
    criteria: []
    rule_ids:
      - LL_QA_007_REQUIRED_STUDIES
      - LL_QA_008_SSO_REQUIRED
      - PG9_016_STEADY_STATE_ANALYSIS_ELEMENT
      - PG9_017_SYSTEM_PROTECTION_SHORT_CIRCUIT_ELEMENT
      - PG9_018_DYNAMIC_TRANSIENT_STABILITY_ELEMENT

  - id: E3R_TO_TDSP
    from: N3R
    to: N3T
    criteria: []
    rule_ids:
      - LL_QA_006_MATERIAL_CHANGE

  # Branch 4: TDSP-specific routing (Oncor vs generic).
  - id: E4_ONCOR
    from: N3T
    to: N4
    criteria:
      - op: equals
        field: tdsp_area
        value: ONCOR
    rule_ids:
      - LL_QA_007_REQUIRED_STUDIES
      - LL_QA_008_SSO_REQUIRED

  - id: E4_GENERIC
    from: N3T
    to: N4G
    criteria: []
    rule_ids:
      - LL_QA_007_REQUIRED_STUDIES

  - id: E5_ONCOR
    from: N4
    to: N5
    criteria: []
    rule_ids:
      - ONCOR_520_106_SYSTEM_PROTECTION_REQUIREMENTS
      - ONC_001_TRANSMISSION_VOLTAGE_SCOPE
      - ONC_010_NOMCR_APPROVAL

  - id: E5_GENERIC
    from: N4G
    to: N5
    criteria: []
    rule_ids:
      - LL_QA_007_REQUIRED_STUDIES

  # Branch 5: energization requested vs feasibility-only memo.
  - id: E6_ENERGIZATION
    from: N5
    to: N5E
    criteria:
      - op: equals
        field: is_requesting_energization
        value: true
    rule_ids:
      - LLI_EN_001_WRITTEN_APPROVAL_REQUIRED
      - LLI_EN_003_LLIS_COMPLETE
      - LLI_EN_006_AGREEMENTS_AND_SECURITY
      - LLI_EN_011_NETWORK_MODEL
      - PG9_019_ENERGIZATION_NOM_INCLUSION
      - PG9_020_ENERGIZATION_TELEMETRY_OPERATIONAL
      - PG9_021_ENERGIZATION_SSO_COMPLETE_IF_REQUIRED
      - PG9_022_ENERGIZATION_CURRENT_LCP_REQUIRED
      - PG9_023_LLIS_COMPLETION_COMMUNICATED
      - PG9_024_AGREEMENTS_AND_FINANCIAL_SECURITY

  - id: E6_FEASIBILITY
    from: N5
    to: N6
    criteria: []
    rule_ids:
      - LL_QA_014_365_DAY_RULE

  - id: E6E_TO_MEMO
    from: N5E
    to: N6
    criteria: []
    rule_ids:
      - LL_QA_011_ENERGIZATION_REQUIREMENTS
      - LL_QA_014_365_DAY_RULE
      - LLI_EN_001_WRITTEN_APPROVAL_REQUIRED
      - LLI_EN_003_LLIS_COMPLETE
      - LLI_EN_006_AGREEMENTS_AND_SECURITY
      - LLI_EN_011_NETWORK_MODEL
      - PG9_019_ENERGIZATION_NOM_INCLUSION
      - PG9_020_ENERGIZATION_TELEMETRY_OPERATIONAL
      - PG9_021_ENERGIZATION_SSO_COMPLETE_IF_REQUIRED
      - PG9_022_ENERGIZATION_CURRENT_LCP_REQUIRED
      - PG9_023_LLIS_COMPLETION_COMMUNICATED
      - PG9_024_AGREEMENTS_AND_FINANCIAL_SECURITY

levers_catalog:
  - lever_id: phased_energization
    label: Phased energization plan
    request_fields:
      - energization_plan
      - phases
  - lever_id: voltage_level_choice
    label: POI voltage level choice
    request_fields:
      - voltage_options_kv
  - lever_id: energization_posture_timing
    label: Energization posture & timing
    request_fields:
      - is_requesting_energization
      - requested_energization_window
  - lever_id: change_control_restudy
    label: Change control / re-study triggers
    request_fields:
      - material_change_flags
  - lever_id: agreements_security_ntp
    label: Agreements, financial security & notice-to-proceed
    request_fields:
      - llis_completed_and_ercot_approved
      - agreements_executed
      - financial_security_posted
      - notice_to_proceed_received
  - lever_id: llis_data_package_readiness
    label: LLIS study data package readiness
    request_fields:
      - llis_data_package_submitted
  - lever_id: quarterly_stability_readiness
    label: ERCOT quarterly stability assessment readiness (if applicable)
    request_fields:
      - ercot_quarterly_stability_assessment_complete
